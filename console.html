<html>

<head>

    <title>
        HackSlash
    </title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

    <style type="text/css">
    
        @font-face {
            font-family: '8bit_wondernominal';
            src: url('assets/8-bit_wonder-webfont.eot');
            src: url('assets/8-bit_wonder-webfont.eot?#iefix') format('embedded-opentype'),
                url('assets/8-bit_wonder-webfont.woff2') format('woff2'),
                url('assets/8-bit_wonder-webfont.woff') format('woff'),
                url('assets/8-bit_wonder-webfont.ttf') format('truetype'),
                url('assets/8-bit_wonder-webfont.svg#8bit_wondernominal') format('svg');
            font-weight: normal;
            font-style: normal;
    }
    
        body { 
            font-size: 15px; 
            font-family :sans-serif;
            background-image: url('assets/mapbackgroundnofence.png');
            background-repeat: repeat;
            
        }
        
        h1 { 
            font-size: 25px;
            font-weight: bold;
        }
        
        h2 { 
            font-size: 20px;
            font-weight: bold;
        }
        
        section {
            float: left;
            width: 70%;
            position: absolute;
        }
            
        aside {
            font-family: '8bit_wondernominal';
            background-color: rgba(0, 0, 0, 0.6);
            color: #ffffff;
            float: right;
            width: 300px;
            height: 100%;
            padding-left: 10px;
            padding-right: 10px;
            position: fixed, absolute;
        }
            
        #titleRow {
            float: top;
            height: 20px;
            text-align: center;
            padding-left: 8px;
            padding-right: 8px;
            padding-bottom: 13px;
            border-bottom: 1px solid;
        }
        
        #namesTable {
            float: top;
            height: 100%;
            font-size: 20px;
            color: #ffffff;
            padding: 3px;
        }
        
        .tableRow {
            height: 40px;
            width: 300px;
            position: relative;
        }

        .left {
            height: 40px;
            width: 150px;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .right {
            height: 40px;
            width: 150px;
            position: absolute;
            text-align: right;
            top: 0;
            right: 0;
        }
        
        #container {
            position: relative;
            width: 814px;
            height: 814px;
            background-image: url('assets/mapbackground.png');
            background-size: cover;
        }

        #canvas {
            top:32px;
            left:32px;
            height: 750px;
            width: 750px;
            position: absolute;
        }
        
        .sprite {
            height: 5%;
            width: 5%;
            background-size: cover;
            position: absolute;
            transition: left 0.5s, top 0.5s;
        }
       
    </style>

</head>

<body>
    
        <section id= "canvasWrapper">
        
        <div id="container">
            
            <div id="canvas"></div>
            
            <button onclick="newUser()">new</button>
            <button title="up" onclick="moveUp('0')">up</button>
            <button title="down" onclick="moveDown('0')">down</button>
            <button title="left" onclick="moveLeft('0')">left</button>
            <button title="right" onclick="moveRight('0')">right</button>
            <button title="attack" onclick="attack('0')">attack</button>
            
            <audio id="audioTrack" preload="auto" oncanplaythrough="this.play();">
                <source src="audio/bg.mp3" type="audio/mpeg">
            </audio>
            
        </div>
            
        </section>
    
        <aside id="scoreboard">
            <div id="titleRow">
                <h1>High scores</h1>
            </div>
            
            <div id="namesTable">

            </div>
            
        </aside>
    
    <script type="text/javascript">
    function newUser(user){
        var sprite = user.sprite;
        var userUuid = user.uuid;
        $("#canvas").append('<div sprite="1" dir="down" id="sprite'+userUuid+'"class="sprite" style="top: '+(user.top*5)+'%; left: '+(user.left*5)+'%; background-image: url(\'assets/sprites/'+sprite+'/down_still_noattack_'+sprite+'.png\')"></div>');
    }
    
    function updateBoard(){
        var scoreArray = [["abcdef", "9001"], ["catcat", "8999"], ["tabtab", "538"]]

        for (var i=0; i < scoreArray.length; i++) {
            $('#namesTable').append('<div class="tableRow"><div class="left">'+ scoreArray[i][0] +'</div><div class="right">'+ scoreArray[i][1] +'</div></div>')
        }       
    }

    function moveUp(spriteId){
        var spriteEle = document.getElementById('sprite'+spriteId);
        var sprite = spriteEle.getAttribute('sprite');
        spriteEle.setAttribute('dir', 'up');

        spriteEle.style.top = (parseInt(spriteEle.style.top.substring(0, spriteEle.style.top.length - 1)) - 5) + '%';
        spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/up_llmove_noattack_'+sprite+'.png)';
        
        setTimeout(function(){
            spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/up_still_noattack_'+sprite+'.png)';
            setTimeout(function(){
                spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/up_rlmove_noattack_'+sprite+'.png)';
                setTimeout(function(){
                    spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/up_still_noattack_'+sprite+'.png)';
                },150);
            },150);
        },150);
    }

    function moveDown(spriteId){
        var spriteEle = document.getElementById('sprite'+spriteId);
        var sprite = spriteEle.getAttribute('sprite');
        spriteEle.setAttribute('dir', 'down');

        spriteEle.style.top = (parseInt(spriteEle.style.top.substring(0, spriteEle.style.top.length - 1)) + 5) + '%';
        spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/down_llmove_noattack_'+sprite+'.png)';
        setTimeout(function(){
            spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/down_still_noattack_'+sprite+'.png)';
            setTimeout(function(){
                spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/down_rlmove_noattack_'+sprite+'.png)';
                setTimeout(function(){
                    spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/down_still_noattack_'+sprite+'.png)';
                },150);
            },150);
        },150);
    }

    function moveLeft(spriteId){
        var spriteEle = document.getElementById('sprite'+spriteId);
        var sprite = spriteEle.getAttribute('sprite');
        spriteEle.setAttribute('dir', 'left');

        spriteEle.style.left = (parseInt(spriteEle.style.left.substring(0, spriteEle.style.left.length - 1)) - 5) + '%';
        spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/left_llmove_noattack_'+sprite+'.png)';
        setTimeout(function(){
            spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/left_still_noattack_'+sprite+'.png)';
            setTimeout(function(){
                spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/left_rlmove_noattack_'+sprite+'.png)';
                setTimeout(function(){
                    spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/left_still_noattack_'+sprite+'.png)';
                },150);
            },150);
        },150);
    }

    function moveRight(spriteId){
        var spriteEle = document.getElementById('sprite'+spriteId);
        var sprite = spriteEle.getAttribute('sprite');
        spriteEle.setAttribute('dir', 'right');

        spriteEle.style.left = (parseInt(spriteEle.style.left.substring(0, spriteEle.style.left.length - 1)) + 5) + '%';
        spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/right_llmove_noattack_'+sprite+'.png)';
        setTimeout(function(){
            spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/right_still_noattack_'+sprite+'.png)';
            setTimeout(function(){
                spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/right_rlmove_noattack_'+sprite+'.png)';
                setTimeout(function(){
                    spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/right_still_noattack_'+sprite+'.png)';
                },150);
            },150);
        },150);
    }
    
    function attack(spriteId){
        var spriteEle = document.getElementById('sprite'+spriteId);
        var sprite = spriteEle.getAttribute('sprite');
        var spriteDir = spriteEle.getAttribute('dir');
        
        spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/'+spriteDir+'_still_attack1_'+sprite+'.png)';
        setTimeout(function(){
            spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/'+spriteDir+'_still_attack2_'+sprite+'.png)';
            setTimeout(function(){
                spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/'+spriteDir+'_still_attack1_'+sprite+'.png)';
                setTimeout(function(){
                    spriteEle.style.backgroundImage = 'url(assets/sprites/'+sprite+'/'+spriteDir+'_still_noattack_'+sprite+'.png)';
                },100);
            },100);
        },100);
    }
    
    window.onload( 
        updateBoard();

        var uuid = false;

        URL = "ws://guts2015ws.ngrok.com";

        // create new socket on page load
        socket = new WebSocket(URL, "echo-protocol");

        socket.addEventListener("open", function(event) {
          console.log("Connected!");
          socket.send(JSON.stringify({"uuid": uuid, "type": "secret", "secret": "SOME_SECRET_KEY"}));
        });

        socket.addEventListener("message", function(event) {
          // messages received are in here!!
          try {
            var res = JSON.parse(event.data);

            if (res.uuid) {
              uuid = res.uuid;
              console.log(uuid);
            }

            if (res.secret) {
              console.log('Auth successful.');
            }

            if (res.type && res.type == "new") {
              newUser(res.user);
            }

            if (res.move) {
              switch(res.move){
                case "up":
                  moveUp(res.uuid);
                  break;
                case "down":
                  moveDown(res.uuid);
                  break;
                case "left":
                  moveLeft(res.uuid);
                  break;
                case "right":
                  moveRight(res.uuid);
                  break;
              }
            }

          } catch (e) {
            //console.log(e);
          }
          console.log(event.data);
        });

        socket.addEventListener("close", function(event) {
          console.log("Disconnected from the server!");
        });
    );
    </script>

</body>

</html>